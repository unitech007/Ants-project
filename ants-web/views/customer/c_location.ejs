<% include ../partials/header %>

<title>Ants: Update Location</title>
<link rel="stylesheet" href="/stylesheets/form.css" />

<% include ../partials/navbar %>

<div class="container form-content">
  <h1 class="text-center">Update Location for <%= currentUser.username %></h1>
  <div class="form-container">
    <button id="fetchLocationBtn" class="btn btn-lg btn-success btn-block">Fetch My Location</button>
    <form id="locationForm" action="/customer/location/<%= currentUser._id %>?_method=PUT" method="POST">
      <div class="form-group">
        <label for="area">Area</label>
        <input class="form-control" type="text" maxlength="100" name="area" id="area" value="<%= currentUser.area %>" required>
      </div>
      <div class="form-group">
        <label for="city">City</label>
        <input class="form-control" type="text" maxlength="100" name="city" id="city" value="<%= currentUser.city %>" required>
      </div>
      <div class="form-group">
        <label for="state">State</label>
        <input class="form-control" type="text" maxlength="100" name="state" id="state" value="<%= currentUser.state %>" required>
      </div>
      <div class="form-group">
        <label for="pincode">Pin Code</label>
        <input class="form-control" type="text" maxlength="6" pattern="\d{6}" name="pincode" id="pincode" value="<%= currentUser.pincode %>" required>
      </div>
      <div class="form-group">
        <button class="btn btn-lg btn-primary btn-block">Update Location</button>
      </div>
    </form>
    <a href="/services">Cancel</a>
  </div>
</div>

<script>
  document.getElementById('fetchLocationBtn').addEventListener('click', function(e) {
    e.preventDefault();
    
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        const lat = position.coords.latitude;
        const long = position.coords.longitude;
        
        // Fetch location details using reverse geocoding (example with OpenStreetMap API)
        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${long}&format=json`)
          .then(response => response.json())
          .then(data => {
            if (data.address) {
              document.getElementById('area').value = data.address.neighbourhood || data.address.suburb || "";
              document.getElementById('city').value = data.address.city || data.address.town || data.address.village || "";
              document.getElementById('state').value = data.address.state || "";
              document.getElementById('pincode').value = data.address.postcode || "";
            }
          })
          .catch(error => console.error('Error fetching location:', error));
      }, function(error) {
        console.error('Error retrieving geolocation:', error);
      });
    } else {
      alert('Geolocation is not supported by your browser.');
    }
  });
</script>

<% include ../partials/footer %>
